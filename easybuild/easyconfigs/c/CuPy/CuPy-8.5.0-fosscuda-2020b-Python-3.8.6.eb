easyblock = 'PythonBundle'

name = 'CuPy'
version = '8.5.0'
versionsuffix = '-Python-%(pyver)s'

homepage = 'https://cupy.dev'
description = "CuPy is an open-source array library accelerated with NVIDIA CUDA."

toolchain = {'name': 'fosscuda', 'version': '2020b'}
builddependencies = [('Cython', '0.29.22', versionsuffix)]
dependencies = [
    ('Python', '3.8.6'),
    ('SciPy-bundle', '2020.11'),
    ('cuDNN', '8.0.4.30', '-CUDA-11.1.1', True),
    ('NCCL', '2.8.3', '-CUDA-11.1.1', True),
    ('cuTENSOR', '1.2.2.5'),
]

use_pip = True

exts_default_options = {'source_urls': [PYPI_LOWER_SOURCE]}
postinstallcmds = [
    # req for sanity check on build nodes without libcuda.so
    'cp $EBROOTCUDA/./targets/x86_64-linux/lib/stubs/libcuda.* %(installdir)s/lib && ls %(installdir)s/lib'
]
exts_list = [
    ('fastrlock', '0.5', {
        'checksums': ['9ae1a31f6e069b5f0f28ba63c594d0c952065de0a375f7b491d21ebaccc5166f'],
    }),
    ('cupy', version, {
        'patches': ['CuPy-8.5.0_sanitycheck_fix.patch'],
        'checksums': [
            'fb3f8d3b3454beb249b9880502a45fe493c5a44efacc4c72914cbe1a5dbdf803',  # cupy-8.5.0.tar.gz
            '7dff0987cccc69bf80b540291f18a7ddea03099d050f83af0c753395fe41f1d7',  # CuPy-8.5.0_sanitycheck_fix.patch
        ],
    }),
]

sanity_pip_check = True

moduleclass = 'lib'
