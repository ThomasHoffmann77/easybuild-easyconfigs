# created by Denis Kristak (Inuits)
# update: Thomas Hoffmann, EMBL
easyblock = 'PythonBundle'

name = 'AlphaPulldown'
version = '2.0.0b4'
versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://github.com/KosinskiLab/AlphaPulldown'
description = """AlphaPulldown is a Python package that streamlines protein-protein
interaction screens and high-throughput modelling of higher-order oligomers using AlphaFold-Multimer"""

toolchain = {'name': 'foss', 'version': '2023a'}

dependencies = [
    ('CUDA', '12.1.1', '', SYSTEM),
    ('Python', '3.11.3'),
    ('OpenMM', '8.0.0', versionsuffix),
    ('Kalign', '3.4.0'),
    ('PyYAML', '6.0'),
    ('jax', '0.4.25', versionsuffix),  # also provides absl-py
    ('Biopython', '1.83'),
    ('h5py', '3.9.0'),
    ('IPython', '8.14.0'),
    ('JupyterLab', '4.0.5'),
    ('matplotlib', '3.7.2'),
    ('TensorFlow', '2.15.1', versionsuffix),
    ('PyTorch', '2.1.2', versionsuffix),
    ('tqdm', '4.66.1'),
    ('dm-tree', '0.1.8'),
    ('py3Dmol', '2.1.0'),
    ('HMMER', '3.4'),
    ('HH-suite', '3.3.0'),
    ('dm-haiku', '0.0.11', versionsuffix),
    ('Uni-Core', '0.0.3', versionsuffix),
]

use_pip = True

exts_list = [
    ('contextlib2', '21.6.0', {
        'checksums': ['ab1e2bfe1d01d968e1b7e8d9023bc51ef3509bba217bb730cee3827e1ee82869'],
    }),
    ('ml-collections', '0.1.1', {
        'preinstallopts': "touch requirements.txt && touch requirements-test.txt && ",
        'sources': ['ml_collections-%(version)s.tar.gz'],
        'checksums': ['3fefcc72ec433aa1e5d32307a3e474bbb67f405be814ea52a2166bfc9dbe68cc'],
    }),
    ('PDBFixer', '1.9', {
        'source_urls': ['https://github.com/openmm/pdbfixer/archive/'],
        'sources': [{'download_filename': '%(version)s.tar.gz', 'filename': '%(name)s-%(version)s.tar.gz'}],
        'checksums': ['88b9a77e50655f89d0eb2075093773e82c27a4cef842cb7d735c877b20cd39fb'],
    }),
    (name, version, {
        'patches': ['AlphaPulldown-2.0.0b4_af2_biopython_IUPACData_as_SCOPData.patch'],
        'preinstallopts': "sed -i 's/[>=]=.*//g' setup.cfg && ",
        'sources': [{
            'filename': '%(name)s-%(version)s.tar.gz',
            'git_config': {
                'url': 'https://github.com/KosinskiLab',
                'repo_name': 'AlphaPulldown',
                'tag': '2.0.0b4',
                'recursive': True
            }
        }],
        'checksums': [
            None,
            # AlphaPulldown-2.0.0b4_af2_biopython_IUPACData_as_SCOPData.patch:
            '0f8ff118bbab50b97a397a9e4de890155b77f868db9913ea3b496d422330bc18'
        ],
    }),
]

fix_python_shebang_for = ['bin/*.py']

sanity_pip_check = True

sanity_check_paths = {
    'files': ['bin/run_multimer_jobs.py', 'bin/rename_colab_search_a3m.py'],
    'dirs': ['lib/python%(pyshortver)s/site-packages/alphapulldown'],
}

sanity_check_commands = ["run_multimer_jobs.py --help | grep 'A script to perform structure prediction'"]

moduleclass = 'bio'
