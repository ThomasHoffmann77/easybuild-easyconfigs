# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2024/01
easyblock = 'Conda'
# TODO: PythonBundle, cctbx from source.

name = "AlphaPulldown"
version = "1.0.4"
local_hwtype = 'gpu'
versionsuffix = '-CUDA-%(cudaver)s-conda'


homepage = 'https://www.embl-hamburg.de/AlphaPulldown/'
description = """AlphaPulldown, a Python package that streamlines protein-protein interaction    
screens and high-throughput modelling of higher-order oligomers using AlphaFold-
Multimer. It provides a convenient command line interface, a variety of         
confidence scores, and a graphical analysis tool."""

# toolchain = SYSTEM    # use system if hhsuite and hmmer used from conda
toolchain = {'name': 'foss', 'version': '2022a'}

channels = ['omnia', 'bioconda', 'conda-forge']
requirements = 'python==3.10 '
requirements += 'openmm==8.0 '
requirements += 'pdbfixer=1.9 '
requirements += 'kalign2==2.04 '
requirements += 'cctbx-base==2023.12 '
requirements += 'pytest=8.0.0 '
requirements += 'importlib_metadata '
# requirements+='hhsuite==3.3.0 '

# requirements+='hmmer '   # dependency
# requirements+='hhsuite '  # dependency

builddependencies = [('Anaconda3', '2023.03-1', '', SYSTEM)]
dependencies = [
    ('CUDA', '11.8.0', '', True),
    ('HH-suite', '3.3.0'),
    ('HMMER', '3.3.2'),
    ('cuDNN', '8.7.0.84', '-CUDA-%(cudaver)s', SYSTEM)
    # jax ?
    # openmm ?
]
local_jax_url = 'https://storage.googleapis.com/jax-releases/jax_cuda_releases.html'
postinstallcmds = [
    '%(installdir)s/bin/pip install alphapulldown==%(version)s',
    '%(installdir)s/bin/pip install alphapulldown',
    # '%%(installdir)s/bin/pip install -q "jax[cuda]>=0.3.8,<0.3.10" -f %s' % local_jax_url
    '%%(installdir)s/bin/pip install -q "jax[cuda]==0.4.23" jaxlib==0.4.23+cuda11.cudnn86 -f %s' % local_jax_url
]

# sanity_check_commands = [('create_individual_features.py ','--helpshort')]
sanity_check_paths = {
    'files': [],
    'dirs': ['lib/python3.10/site-packages/alphapulldown']
}

moduleclass = 'bio'
