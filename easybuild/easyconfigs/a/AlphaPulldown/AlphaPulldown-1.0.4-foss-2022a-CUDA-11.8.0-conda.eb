# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2024/01
easyblock = 'Conda'
# TODO: PythonBundle, cctbx from source.

name = "AlphaPulldown"
version = "1.0.4"
local_hwtype = 'gpu'
versionsuffix = '-CUDA-%(cudaver)s-conda'


homepage = 'https://www.embl-hamburg.de/AlphaPulldown/'
description = """AlphaPulldown, a Python package that streamlines protein-protein interaction    
screens and high-throughput modelling of higher-order oligomers using AlphaFold-
Multimer. It provides a convenient command line interface, a variety of         
confidence scores, and a graphical analysis tool."""

# toolchain = SYSTEM    # use system if hhsuite and hmmer used from conda
toolchain = {'name': 'foss', 'version': '2022a'}

channels = ['omnia', 'bioconda', 'conda-forge']

requirements = 'python==3.10 '
requirements += 'openmm==8.0 '
requirements += 'pdbfixer=1.9 '
requirements += 'kalign2==2.04 '
requirements += 'cctbx-base==2023.12 '
requirements += 'pytest=8.0.0 '
requirements += 'importlib_metadata==7.0.1 '
requirements += '_libgcc_mutex==0.1 '
requirements += '_openmp_mutex==4.5 '
requirements += 'biopython==1.83 '
requirements += 'brotli==1.1.0 '
requirements += 'brotli-bin==1.1.0 '
requirements += 'brotli-python=1.1.0 '
requirements += 'bzip2==1.0.8 '
requirements += 'ca-certificates==2023.11.17 '
requirements += 'cairo==1.18.0 '
requirements += 'cctbx-base==2023.12 '
requirements += 'certifi==2023.11.17 '
requirements += 'chardet==5.2.0 '
requirements += 'charset-normalizer==3.3.2 '
requirements += 'colorama==0.4.6 '
requirements += 'contourpy==1.2.0 '
requirements += 'cudatoolkit==11.8.0 '
requirements += 'cycler==0.12.1 '
requirements += 'exceptiongroup==1.2.0 '
requirements += 'expat==2.5.0 '
requirements += 'font-ttf-dejavu-sans-mono==2.37 '
requirements += 'font-ttf-inconsolata==3.000 '
requirements += 'font-ttf-source-code-pro==2.038 '
requirements += 'font-ttf-ubuntu==0.83 '
requirements += 'fontconfig==2.14.2 '
requirements += 'fonts-conda-ecosystem==1 '
requirements += 'fonts-conda-forge==1 '
requirements += 'fonttools==4.47.2 '
requirements += 'freetype==2.12.1 '
requirements += 'freetype-py==2.3.0 '
requirements += 'future==0.18.3 '
requirements += 'gettext==0.21.1 '
requirements += 'icu==73.2 '
requirements += 'idna==3.6 '
requirements += 'importlib-metadata==7.0.1 '
requirements += 'iniconfig==2.0.0 '
requirements += 'kalign2==2.04 '
requirements += 'kiwisolver==1.4.5 '
requirements += 'lcms2==2.16 '
requirements += 'ld_impl_linux-64==2.40 '
requirements += 'lerc==4.0.0 '
requirements += 'libblas==3.9.0 '
requirements += 'libboost==1.82.0 '
requirements += 'libboost-python==1.82.0 '
requirements += 'libbrotlicommon==1.1.0 '
requirements += 'libbrotlidec==1.1.0 '
requirements += 'libbrotlienc==1.1.0 '
requirements += 'libcblas==3.9.0 '
requirements += 'libdeflate==1.19 '
requirements += 'libexpat==2.5.0 '
requirements += 'libffi==3.4.2 '
requirements += 'libgcc-ng==13.2.0 '
requirements += 'libgfortran-ng==13.2.0 '
requirements += 'libgfortran5==13.2.0 '
requirements += 'libglib==2.78.3 '
requirements += 'libglu==9.0.0 '
requirements += 'libgomp==13.2.0 '
requirements += 'libiconv==1.17 '
requirements += 'libjpeg-turbo==3.0.0 '
requirements += 'liblapack==3.9.0 '
requirements += 'libnsl==2.0.1 '
requirements += 'libopenblas==0.3.26 '
requirements += 'libpng==1.6.42 '
requirements += 'libsqlite==3.44.2 '
requirements += 'libstdcxx-ng==13.2.0 '
requirements += 'libsvm==3.16 '
requirements += 'libtiff==4.6.0 '
requirements += 'libuuid==2.38.1 '
requirements += 'libwebp-base==1.3.2 '
requirements += 'libxcb==1.15 '
requirements += 'libzlib==1.2.13 '
requirements += 'matplotlib-base==3.8.2 '
requirements += 'mrcfile==1.5.0 '
requirements += 'munkres==1.0.7 '
requirements += 'ncurses==6.4 '
requirements += 'numpy==1.26.3 '
requirements += 'ocl-icd==2.3.1 '
requirements += 'ocl-icd-system==1.0.0 '
requirements += 'openjpeg==2.5.0 '
requirements += 'openmm==8.0.0 '
requirements += 'openssl==3.2.1 '
requirements += 'packaging==23.2 '
requirements += 'pcre2==10.42 '
requirements += 'pdbfixer==1.9 '
requirements += 'pillow==10.2.0 '
requirements += 'pip==23.3.2 '
requirements += 'pixman==0.43.2 '
requirements += 'pluggy==1.4.0 '
requirements += 'psutil==5.9.8 '
requirements += 'pthread-stubs==0.4 '
requirements += 'pycairo==1.25.1 '
requirements += 'pyparsing==3.1.1 '
requirements += 'pysocks==1.7.1 '
requirements += 'pytest==8.0.0 '
requirements += 'python==3.10.0 '
requirements += 'python-dateutil==2.8.2 '
requirements += 'python_abi==3.10 '
requirements += 'readline==8.2 '
requirements += 'reportlab==4.0.9 '
requirements += 'requests==2.31.0 '
requirements += 'rlpycairo==0.2.0 '
requirements += 'scipy==1.12.0 '
requirements += 'setuptools==69.0.3 '
requirements += 'six==1.16.0 '
requirements += 'sqlite==3.44.2 '
requirements += 'tk==8.6.13 '
requirements += 'tomli==2.0.1 '
requirements += 'tzdata==2023d '
requirements += 'unicodedata2==15.1.0 '
requirements += 'urllib3==2.2.0 '
requirements += 'wheel==0.42.0 '
requirements += 'xorg-kbproto==1.0.7 '
requirements += 'xorg-libice==1.1.1 '
requirements += 'xorg-libsm==1.2.4 '
requirements += 'xorg-libx11==1.8.7 '
requirements += 'xorg-libxau==1.0.11 '
requirements += 'xorg-libxdmcp==1.1.3 '
requirements += 'xorg-libxext==1.3.4 '
requirements += 'xorg-libxrender==0.9.11 '
requirements += 'xorg-renderproto==0.11.1 '
requirements += 'xorg-xextproto==7.3.0 '
requirements += 'xorg-xproto==7.0.31 '
requirements += 'xz==5.2.6 '
requirements += 'zipp==3.17.0 '
requirements += 'zlib==1.2.13 '
requirements += 'zstd==1.5.5 '

# requirements+='hhsuite==3.3.0 '
# requirements+='hmmer '   # dependency
# requirements+='hhsuite '  # dependency

builddependencies = [('Anaconda3', '2023.03-1', '', SYSTEM)]
dependencies = [
    ('CUDA', '11.8.0', '', SYSTEM),
    ('HH-suite', '3.3.0'),
    ('HMMER', '3.3.2'),
    ('cuDNN', '8.7.0.84', '-CUDA-%(cudaver)s', SYSTEM)
    # jax ?
    # openmm ?
]
local_jax_url = 'https://storage.googleapis.com/jax-releases/jax_cuda_releases.html'
postinstallcmds = [
    '%(installdir)s/bin/pip install alphapulldown==%(version)s',
    '%(installdir)s/bin/pip install alphapulldown',
    # '%%(installdir)s/bin/pip install -q "jax[cuda]>=0.3.8,<0.3.10" -f %s' % local_jax_url
    '%%(installdir)s/bin/pip install -q "jax[cuda]==0.4.23" jaxlib==0.4.23+cuda11.cudnn86 -f %s' % local_jax_url
]

# sanity_check_commands = [('create_individual_features.py ','--helpshort')]
sanity_check_paths = {
    'files': [],
    'dirs': ['lib/python3.10/site-packages/alphapulldown']
}

moduleclass = 'bio'
