# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2024/6
easyblock = 'MakeCp'

name = 'AreTomo3'
local_version = '1.0.15'
versionsuffix = '-CUDA-%(cudaver)s'
local_commit_date = '20240620'
local_commit = 'c6c5a13f00e6d94327bb188dd683f596433d3c17'
version = '%s.%s_%s' % (local_version, local_commit_date, local_commit[:7])

homepage = 'https://github.com/czimaginginstitute/AreTomo3'

description = """AreTomo3 is a multi-GPU accelerated software package that enables real-time     
fully automated reconstruction of cryoET tomograms in parallel with cryoET data 
collection. Integrating MotionCor3, AreTomo2, and GCtfFind in a single         
application, AreTomo3 has established an autonomous preprocessing pipeline that,
whenever a new tilt series is collected, can activate and repeat itself from    
correction of beam induced motion and assembling tilt series to CTF estimation  
and correction, tomographic alignment, and 3D reconstruction throughout entire  
session of data collection without human intervention. The end results include  
not only tomograms but also a rich set of alignment parameters to bootstrap     
subtomogram averaging. Our test shows that AreTomo3 can catch up to 9-target    
PACE Tomo data collection with 4 NVidia RTX A6000 GPUs when it was configured to
perform 2D local motion correction on movies and 3D local motion correction on  
tilt series. The offline testing shows that AreTomo3 runs faster than the data  
collection. As a result, GPU resources can be shared with other tasks to expand
the preprocessing capacity. Tomogram denoising and particle picking now can run 
concurrently with AreTomo3 to maximize the preprocessing workflow."""

toolchain = {'name': 'GCCcore', 'version': '12.3.0'}
toolchainopts = {'cstd': 'c++11'}

source_urls = ['https://github.com/czimaginginstitute/AreTomo3/archive/']
sources = [{
    'download_filename': '%s.tar.gz' % local_commit,
    'filename': SOURCE_TAR_GZ
}]
patches = ['AreTomo3-1.0.15_makefile.patch']
checksums = [
    {'AreTomo3-1.0.15.20240620_c6c5a13.tar.gz': '785d005cf838008184a271e85540a8cef1a65d1081db5e3eda448eafd16ce156'},
    {'AreTomo3-1.0.15_makefile.patch': '01331821c1708acff7b0293b9558c16fa43560ce8b644ca51ac26dc3ef5b4cf1'},
]

github_account = 'czimaginginstitute'

build_cmd = 'make exe -f makefile11 CUDAHOME=$CUDA_HOME CUDACC="%(cuda_cc_cmake)s"'

builddependencies = [
    ('binutils', '2.40')
]

dependencies = [
    ('CUDA', '12.1.1', '', SYSTEM),
    ('LibTIFF', '4.5.0')
]

files_to_copy = [(['%(name)s'], 'bin')]

sanity_check_paths = {
    'files': ['bin/%(name)s'],
    'dirs': ['bin'],
}

sanity_check_commands = ['%(name)s -h']

moduleclass = 'bio'
