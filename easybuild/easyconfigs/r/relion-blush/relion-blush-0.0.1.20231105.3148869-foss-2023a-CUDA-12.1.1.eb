# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2023/11
easyblock = 'PythonBundle'

name = 'relion-blush'
_v = '0.0.1'
_sha = '3148869de884fc01cff6c51a047b1413fc0b62cb'
_date = 20231105
version = '%s.%s.%s' % (_v, _date, _sha[:7])

versionsuffix = '-CUDA-%(cudaver)s'

homepage = 'https://github.com/3dem/%(name)s'
description = """This repository contains code for running Blush regularization in RELION-5.
This project is designed to work in conjunction with tools for cryo-electron    
microscopy (cryo-EM) three-dimensional reconstruction. For specific             
functionalities, we leverage the capabilities of RELION, an open-source, highly 
flexible and high-performance solution for cryo-EM.
Estimating dynamics from cryo-EM images and use them to improve your map (maybe)"""

toolchain = {'name': 'foss', 'version': '2023a'}

patches = []

dependencies = [
    ('Python', '3.11.3'),
    ('CUDA', '12.1.1', '', SYSTEM),
    ('PyTorch-bundle', '2.1.2', versionsuffix),
    ('mrcfile', '1.5.0'),
    ('relion-blush_data', '1.0', '', SYSTEM),
]

use_pip = True

exts_list = [
    ('loguru', '0.7.0'),
    (name.replace('-', '_'), '%s.%s' % (_v, _date), {
        'source_urls': ['https://github.com/3dem/relion-blush/archive/'],
        'sources': [{
            'download_filename': '%s.tar.gz' % _sha,
            'filename': '%(name)s-%(version)s.tar.gz'
        }],
        'patches': [
            'relion-blush-0.0.1_relax_requirements.patch',
            'relion-blush-0.0.1_multi_torch_home.patch',
            'relion-blush-0.0.1_add_script.patch',
        ],
    })
]

fix_python_shebang_for = ['bin/command_line.py']

postinstallcmds = ['mv %(installdir)s/bin/{command_line.py,relion_blush}']

sanity_pip_check = True

sanity_check_paths = {
    'files': [],
    'dirs': ['lib/python%(pyshortver)s/site-packages/relion_blush'],
}
sanity_check_commands = ['relion_blush -h']

moduleclass = 'bio'
