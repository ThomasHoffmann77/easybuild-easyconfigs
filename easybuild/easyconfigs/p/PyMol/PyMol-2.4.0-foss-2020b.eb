# Thomas Hoffmann, EMBL Heidelberg, structures-it@embl.de, 2021/04
easyblock = 'PythonPackage'

name = 'PyMol'
version = '2.4.0'

homepage = 'https://github.com/schrodinger/pymol-open-source'
description = """PyMOL is a Python-enhanced molecular graphics tool. It excels at 3D             
visualization of proteins, small molecules, density, surfaces, and trajectories.
It also includes molecular editing, ray tracing, and movies. Open Source PyMOL  
is free to everyone!"""

toolchain = {'name': 'foss', 'version': '2020b'}
source_urls = ['https://github.com/schrodinger/pymol-open-source/archive/refs/tags/']
sources = ['v%(version)s.tar.gz']
patches = [
    'PyMol-2.4.0_openvr_header.patch',     # fix path to openvr.h
    'PyMol-2.4.0_APBS_tools_plugin.patch'  # string.split problem
]
checksums = [
    '5ede4ce2e8f53713c5ee64f5905b2d29bf01e4391da7e536ce8909d6b9116581',  # v2.4.0.tar.gz
    '348ce6956d3b545519e5ccadf75c6c2dd6282dc700f163b0deee93f0afd2fb49',  # PyMol-2.4.0_openvr_header.patch
    '2b2e952c453871cda15d0bacda3b9494c19152ba3ab0af37d4bff640495a6732',  # PyMol-2.4.0_APBS_tools_plugin.patch
]

exts_defaultclass = 'PythonPackage'
exts_list = [
    ('Pmw', '2.0.1', {
        'buildopts': '',
        'installopts': '',
        'modulename': 'Pmw',
        'sources': [{
            'download_filename': '8bedfc8747e7757c1048bc5e11899d1163717a43.zip',
            'source_urls': ['https://github.com/schrodinger/pmw-patched/archive/'],
            'filename': 'Pmw-patched-2.0.1-20200210-8bedfc8.zip'}],
        'use_pip': True,
        'checksums': ['db1ab4ee1020023ad814bb24c74f6361fb72e1011871911f7d37bb6ecf6c79ed'],
    }),
]

dependencies = [
    ('libpng', '1.6.37'),
    ('Python', '3.8.6'),
    ('PyQt5', '5.15.1'),
    ('glew', '2.2.0', '-egl'),
    ('libxml2', '2.9.10'),
    ('freetype', '2.10.3'),
    ('GLM', '0.9.9.8'),
    ('msgpack-c', '3.3.0'),             # optional; if commented out, use --use-msgpackc=no buildopt.
    ('mmtf-cpp', '1.0.0'),              # optional; if commented out, use --use-msgpackc=no buildopt.
    ('OpenVR', '1.0.17'),               # optional; requires 1.0.x acc. to INSTALL
    ('netCDF', '4.7.4'),                # optional; if commented out, use --no-vmd-plugins buildopt.
    ('Tkinter', '%(pyver)s'),           # optional; required for legacy GUI and Pmw, i.e., apbs_tools plugin.
    ('pdb2pqr', '3.1.0'),               # optional, required for apbs_tools plugin
    ('APBS', '3.0.0'),                  # optional, required for apbs_tools plugin
    #  ('freeglut','3.2.1'),            # optional; required for glut legacy GUI (buildopt --glut)
]

download_dep_fail = True
use_pip = False

buildopts = ''
# buildopts += '--glut '             # legacy GUI
# buildopts += '--no-vmd-plugins '   # uncomment if no netCDF dependency 
# buildopts += '--use-msgpackc=no '  # uncomment if no msgpack-c and mmtf-cpp dependency 
buildopts += '--openvr '             # requires OpenVR dependency.
installopts = buildopts

modextravars = {'PYMOL_PATH': 'lib/python%(pyshortver)s/site-packages/pymol/pymol_path'}

sanity_pip_check = True
sanity_check_paths = {
    'files': ['bin/pymol'],
    'dirs': ['bin', 'lib']
}

moduleclass = 'vis'
